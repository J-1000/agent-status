#!/usr/bin/env python3
"""claude-status â€” show running Claude Code sessions across Ghostty tabs."""

import argparse
import os
import subprocess
import sys


def parse_args():
    parser = argparse.ArgumentParser(
        description="Show running Claude Code sessions",
    )
    parser.add_argument(
        "--watch", action="store_true", help="re-print every 2 seconds"
    )
    parser.add_argument(
        "--json", action="store_true", dest="json_output", help="output as JSON"
    )
    return parser.parse_args()


def discover_claude_pids():
    """Find PIDs of running `claude` processes via ps (more reliable than pgrep)."""
    try:
        result = subprocess.run(
            ["ps", "-ax", "-o", "pid=,comm="],
            capture_output=True,
            text=True,
        )
        if result.returncode != 0:
            return []
        pids = []
        for line in result.stdout.strip().split("\n"):
            parts = line.strip().split(None, 1)
            if len(parts) == 2 and parts[1] == "claude":
                pids.append(int(parts[0]))
        return pids
    except FileNotFoundError:
        return []


def get_process_info(pids):
    """Get CPU%, state, and TTY for each PID in one ps call."""
    if not pids:
        return {}
    pid_str = ",".join(str(p) for p in pids)
    try:
        result = subprocess.run(
            ["ps", "-p", pid_str, "-o", "pid=,pcpu=,state=,tty="],
            capture_output=True,
            text=True,
        )
        if result.returncode != 0:
            return {}
    except FileNotFoundError:
        return {}

    info = {}
    for line in result.stdout.strip().split("\n"):
        if not line.strip():
            continue
        parts = line.split()
        if len(parts) >= 4:
            pid = int(parts[0])
            cpu = float(parts[1])
            state = parts[2]
            tty = parts[3]
            info[pid] = {"cpu": cpu, "state": state, "tty": tty}
        elif len(parts) == 3:
            # tty might be missing (shows as ??)
            pid = int(parts[0])
            cpu = float(parts[1])
            state = parts[2]
            info[pid] = {"cpu": cpu, "state": state, "tty": "??"}
    return info


def get_cwd(pid):
    """Resolve working directory for a process via lsof."""
    try:
        result = subprocess.run(
            ["lsof", "-a", "-p", str(pid), "-d", "cwd", "-Fn"],
            capture_output=True,
            text=True,
        )
        for line in result.stdout.strip().split("\n"):
            if line.startswith("n"):
                return line[1:]
    except FileNotFoundError:
        pass
    return None


def get_ghostty_surface_id(pid):
    """Try to extract GHOSTTY_SURFACE_ID from process environment."""
    try:
        result = subprocess.run(
            ["ps", "-p", str(pid), "-wwwE"],
            capture_output=True,
            text=True,
        )
        output = result.stdout
        for token in output.split():
            if token.startswith("GHOSTTY_SURFACE_ID="):
                return token.split("=", 1)[1]
    except FileNotFoundError:
        pass
    return None


def main():
    args = parse_args()
    pids = discover_claude_pids()
    if not pids:
        print("No active Claude Code sessions found.")
        return
    info = get_process_info(pids)
    for pid, data in info.items():
        cwd = get_cwd(pid)
        project = os.path.basename(cwd) if cwd else "unknown"
        surface_id = get_ghostty_surface_id(pid)
        print(f"  PID {pid}: {project} cpu={data['cpu']}% tty={data['tty']} surface={surface_id}")


if __name__ == "__main__":
    main()
